<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  Querying the REDCap API on Windows: avoiding 443 errors and RCurl woes | SIH Tech Tidbits
</title>
  <link rel="canonical" href="https://sydney-informatics-hub.github.io/tidbits/querying-the-redcap-api-on-windows-avoiding-443-errors-and-rcurl-woes.html">


  <link rel="stylesheet" href="https://sydney-informatics-hub.github.io/tidbits/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://sydney-informatics-hub.github.io/tidbits/theme/css/fontawesome.min.css">
  <link rel="stylesheet" href="https://sydney-informatics-hub.github.io/tidbits/theme/css/pygments/paraiso-dark.min.css">
  <link rel="stylesheet" href="https://sydney-informatics-hub.github.io/tidbits/theme/css/theme.css">
  <link rel="stylesheet" href="https://sydney-informatics-hub.github.io/tidbits/static/css/tag_cloud.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://sydney-informatics-hub.github.io/tidbits/feeds/all.atom.xml">
  <link rel="alternate" type="application/atom+xml" title="Categories Atom Feed"
        href="https://sydney-informatics-hub.github.io/tidbits/feeds/r.atom.xml">  
  <meta name="description" content="One of the most attractive features of the REDCap API over other survey tools like Qualtrics, Google Forms and SurveyMonkey is the fact that the API playground supports GUI-style selection â€¦">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
  <div class="col-sm-12">
    <h1 class="title"><a href="https://sydney-informatics-hub.github.io/tidbits/">SIH Tech Tidbits</a></h1>
      <p class="text-muted">Useful tips, libraries and tools from the <a href='https://www.sydney.edu.au/research/facilities/sydney-informatics-hub.html'>Sydney Informatics Hub</a> team</p>
  </div>
</div>

<div id="search_box">
  <h5 class="h5">Search:</h5>
  <form>
    <div class="form-row">
      <div class="col-auto">
        <input
          class="form-control"
          type="text"
          name="q"
          id="tipue_search_input"
          pattern=".{3,}"
          title="At least 3 characters"
          required
        />
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">
          <span class="fa fa-search"></span>
        </button>
      </div>
    </div>
  </form>
  <div id="tipue_search_content"></div>
</div>

    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Querying the REDCap API on Windows: avoiding 443 errors and RCurl woes
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2021-04-09T00:00:00+10:00">
          <i class="fas fa-clock"></i>
          Fri 09 April 2021
        </li>
        <li class="list-inline-item">
          <i class="fas fa-folder-open"></i>
          <a href="https://sydney-informatics-hub.github.io/tidbits/category/r.html">R</a>
        </li>
          <li class="list-inline-item">
            <i class="fas fa-user"></i>
              <a href="https://sydney-informatics-hub.github.io/tidbits/author/darya-vanichkina.html">Darya Vanichkina</a>          </li>
          <li class="list-inline-item">
            <i class="fas fa-tag"></i>
              <a href="https://sydney-informatics-hub.github.io/tidbits/tag/r.html">#r</a>,               <a href="https://sydney-informatics-hub.github.io/tidbits/tag/redcap.html">#redcap</a>,               <a href="https://sydney-informatics-hub.github.io/tidbits/tag/api.html">#api</a>,               <a href="https://sydney-informatics-hub.github.io/tidbits/tag/windows.html">#windows</a>,               <a href="https://sydney-informatics-hub.github.io/tidbits/tag/osx.html">#osx</a>,               <a href="https://sydney-informatics-hub.github.io/tidbits/tag/reproducibility.html">#reproducibility</a>          </li>
      </ul>
    </header>
    <div class="content">
      <p>One of the most attractive features of the REDCap API over other survey tools like Qualtrics, Google Forms and SurveyMonkey is the fact that the API playground supports GUI-style selection of what you want, with REDCap providing template code in a wide variety of languages. </p>
<p><img alt="" src="https://sydney-informatics-hub.github.io/tidbits/images/redcapAPI/2104_what2exportREDCap.png"></p>
<p>Languages include PHP, Perl, Python, R, Ruby, Java &amp; UNIX's curl, and output format options include json, csv and XML.</p>
<p>Further, when you request to export Records, it will nicely provide you with even more options that allow you to point and click to get the actual, real data you want, without needing to delve into the joys of XPATHs and XML.</p>
<p><img alt="" src="https://sydney-informatics-hub.github.io/tidbits/images/redcapAPI/2104_RecordsExport.png"></p>
<p>Under the hood, this is a POST form, and REDCap will explicitly show you what data you've submitted in the "Raw request parameters" tab.</p>
<p>It will also provide you with the code you'd use to get the same data programmatically. There's also a "Click the Execute Request button to execute a real API request, and it will display the API response in a text box below." so you can preview what you'd get back as an object when loading this into your programming language of choice. </p>
<p><img alt="" src="https://sydney-informatics-hub.github.io/tidbits/images/redcapAPI/2104_PostForm.png"></p>
<p>As an example, when I try to retrieve the records from our feedback form (which I've called <code>myformname</code> in the images/code above), it suggests the following R code for me (this returns the records themselves in a csv, and the errors in json):</p>
<div class="highlight"><pre><span></span><code><span class="c1">#!/usr/bin/env Rscript</span>
<span class="n">apisecret</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&#39;myapikey&#39;</span><span class="w"> </span><span class="c1"># you get this when you enable REDCap API access for your project</span>
<span class="nf">library</span><span class="p">(</span><span class="n">RCurl</span><span class="p">)</span>
<span class="n">result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">postForm</span><span class="p">(</span>
<span class="w">    </span><span class="n">uri</span><span class="o">=</span><span class="s">&#39;https://redcap.sydney.edu.au/api/&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">token</span><span class="o">=</span><span class="n">apisecret</span><span class="p">,</span>
<span class="w">    </span><span class="n">content</span><span class="o">=</span><span class="s">&#39;record&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">format</span><span class="o">=</span><span class="s">&#39;csv&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">type</span><span class="o">=</span><span class="s">&#39;flat&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">csvDelimiter</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&#39;forms[0]&#39;</span><span class="o">=</span><span class="s">&#39;myformname&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">rawOrLabel</span><span class="o">=</span><span class="s">&#39;raw&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">rawOrLabelHeaders</span><span class="o">=</span><span class="s">&#39;raw&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">exportCheckboxLabel</span><span class="o">=</span><span class="s">&#39;false&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">exportSurveyFields</span><span class="o">=</span><span class="s">&#39;true&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">exportDataAccessGroups</span><span class="o">=</span><span class="s">&#39;false&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">returnFormat</span><span class="o">=</span><span class="s">&#39;json&#39;</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>

<p>And all is well and good ... if you're on a Mac! However, when I recently tried to run this (fully working!) code on a Windows machine (since this particular survey data goes into a PowerBI dashboard I've built) - I encountered a 443 error instead! Apparently, this is a <a href="https://github.com/dewittpe/REDCapExporter/issues/16">known issue</a>, but while it's suggested to use the <code>httr</code> package instead (or one of the dedicated REDCap R packages), there was no template code available. </p>
<p>After a bit of exploration, the below ended up working, and I'm sharing this template code in the hopes of saving others (at Sydney Uni and elsewhere) the hassle of having to figure this out:</p>
<div class="highlight"><pre><span></span><code><span class="c1">#!/usr/bin/env Rscript</span>
<span class="n">apisecret</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&#39;myapikey&#39;</span><span class="w"> </span><span class="c1"># you get this when you enable REDCap API access for your project</span>
<span class="nf">library</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span>
<span class="n">h1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new_handle</span><span class="p">()</span>
<span class="nf">handle_setform</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;token&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apisecret</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;content&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;record&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="s">&#39;format&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;csv&quot;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;type&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;flat&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;csvDelimiter&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;,&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;forms[0]&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;myformname&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;rawOrLabel&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;raw&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;rawOrLabelHeaders&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;raw&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;exportCheckboxLabel&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;false&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;exportSurveyFields&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;true&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;exportDataAccessGroups&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;false&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;returnFormat&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;json&#39;</span><span class="p">)</span>

<span class="n">surveyresults</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">read.csv</span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rawToChar</span><span class="p">(</span>
<span class="w">  </span><span class="nf">curl_fetch_memory</span><span class="p">(</span><span class="s">&quot;https://redcap.sydney.edu.au/api/&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h1</span><span class="p">)</span><span class="o">$</span><span class="n">content</span><span class="p">),</span>
<span class="w">  </span><span class="n">na.strings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="p">)</span>
</code></pre></div>

<p>Now, the <code>curl::handle_setform()</code> command looks pretty similar to the <code>RCurl::postForm()</code> request, but it needs to be combined with the <code>curl::curl_fetch_memory()</code> command<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>, which has a few quirks:</p>
<ol>
<li>It returns the actual data in the <code>content</code> attribute, and not the data frame directly - hence the need for the <code>$content</code></li>
<li>It returns the data in raw format (and, no, setting the <code>rawOrLabel</code> to label does not solve this), so you need to pass it into <code>base::rawToChar()</code>.</li>
<li><code>read.csv</code>'s defaults are to accept a filepath, so we use an arguement called <code>text</code> to specify that we're straight feeding in the actual data in instead.</li>
</ol>
<p>The other useful thing to "grab" when working with data tends to be the data dictionary, for which the code looks quite similar:</p>
<div class="highlight"><pre><span></span><code><span class="c1">#!/usr/bin/env Rscript</span>
<span class="n">apisecret</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&#39;myapikey&#39;</span><span class="w"> </span><span class="c1"># you get this when you enable REDCap API access for your project</span>
<span class="n">h2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new_handle</span><span class="p">()</span>
<span class="nf">handle_setform</span><span class="p">(</span><span class="n">h2</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;token&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apisecret</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;content&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;metadata&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="s">&#39;format&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;csv&quot;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;forms[0]&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;myformname&#39;</span><span class="p">,</span>
<span class="w">               </span><span class="s">&#39;returnFormat&#39;</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;csv&#39;</span><span class="p">)</span>


<span class="n">datadict</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">read.csv</span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rawToChar</span><span class="p">(</span>
<span class="w">  </span><span class="nf">curl_fetch_memory</span><span class="p">(</span><span class="s">&quot;https://redcap.sydney.edu.au/api/&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h2</span><span class="p">)</span><span class="o">$</span><span class="n">content</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<p>I hope this is helpful for others who use REDCap on Windows, or who need to write code that works across all of the major operating system platforms!</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>Yes, we could have used the <code>curl::curl_fetch_disk()</code> command to download the file to disk, which seems to work a lot better and actually save the file as a non-binary .csv file. However, for this particular project, I'm doing a lot of data cleaning <em>before</em> I write the output to disk, and I'd rather not store two copies of the same scrape.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="https://sydney-informatics-hub.github.io/tidbits/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="https://sydney-informatics-hub.github.io/tidbits/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="https://sydney-informatics-hub.github.io/tidbits/categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="https://sydney-informatics-hub.github.io/tidbits/tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://sydney-informatics-hub.github.io/tidbits/static/js/tipuesearch.min.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://sydney-informatics-hub.github.io/tidbits/static/js/tipuesearch_set.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://sydney-informatics-hub.github.io/tidbits/tipuesearch_content.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://sydney-informatics-hub.github.io/tidbits/static/js/activate_search.js" crossorigin="anonymous"></script>
</body>

</html>